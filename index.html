<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microbiología Quiz</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --clinical-color: #e67e22;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            --correct-color: #27ae60;
            --wrong-color: #c0392b;
            --ai-color: #8e44ad;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
        }

        .container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            max-width: 650px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        /* --- Header --- */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        h1 { font-size: 1.5rem; color: var(--primary-color); margin: 0; }
        
        .score-badge { 
            background: var(--primary-color); 
            color: white; 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 0.9rem; 
            font-weight: bold;
        }

        /* --- Configuración --- */
        .config-box {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        select {
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background-color: white;
            color: var(--text-color);
            width: 100%;
            cursor: pointer;
        }

        /* --- Quiz UI --- */
        .badge-type {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .type-theory { background: var(--accent-color); color: white; }
        .type-clinical { background: var(--clinical-color); color: white; }

        .question-content { margin: 20px 0; }

        .main-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .sub-text {
            font-size: 1.1rem;
            font-style: italic;
            color: #555;
            min-height: 1.5em;
        }

        /* --- Botones de Opción --- */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        @media (min-width: 500px) { .options-grid { grid-template-columns: 1fr 1fr; } }

        button.option-btn {
            padding: 15px;
            font-size: 1rem;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            color: #34495e;
            transition: all 0.2s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        button.option-btn:hover:not([disabled]) {
            background-color: #e8f6fd;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        button.correct { background-color: var(--correct-color) !important; color: white !important; border-color: var(--correct-color) !important; }
        button.wrong { background-color: var(--wrong-color) !important; color: white !important; border-color: var(--wrong-color) !important; opacity: 0.8; }

        /* --- Botones de Acción --- */
        .action-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1rem;
            border-radius: 8px;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .action-btn:hover { background-color: #2980b9; }

        .ai-btn {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white;
            margin-top: 10px;
            display: none;
            border: none;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s;
        }

        .ai-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
        }

        /* --- Feedback y Errores --- */
        .feedback-area {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            display: none;
        }
        
        .feedback-visible { display: block; animation: fadeIn 0.3s; }

        .mistakes-container {
            margin-top: 20px;
            text-align: left;
            background-color: #fff5f5;
            border: 1px solid #ffcccc;
            border-radius: 8px;
            padding: 15px;
        }

        .mistakes-list {
            padding-left: 25px;
            margin: 10px 0 0 0;
            color: #c0392b;
        }
        
        .mistakes-list li { margin-bottom: 8px; }

        .hide { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <!-- PANTALLA DE INICIO -->
    <div class="container" id="start-screen">
        <h1>Microbiología</h1>
        <p style="color: #666; margin-bottom: 30px;">Selecciona la configuración:</p>
        
        <div class="config-box">
            <label for="q-count-select" style="font-weight: bold; text-align: left;">Cantidad de preguntas:</label>
            <select id="q-count-select">
                <option value="5">5 Preguntas (Rápido)</option>
                <option value="10" selected>10 Preguntas (Estándar)</option>
                <option value="15">15 Preguntas</option>
                <option value="20">20 Preguntas</option>
                <option value="999">Todas las posibles</option>
            </select>
        </div>

        <button class="action-btn" onclick="initGame()">COMENZAR EXAMEN</button>
    </div>

    <!-- PANTALLA DE JUEGO -->
    <div class="container hide" id="game-container">
        <div class="header-bar">
            <h1>Microbiología</h1>
            <div class="score-badge">
                <span id="question-counter">1/10</span> | <span id="score-display">Pts: 0</span>
            </div>
        </div>

        <!-- Área de la pregunta -->
        <div id="quiz-area">
            <span id="question-badge" class="badge-type type-theory">Teoría</span>
            
            <div class="question-content">
                <div id="primary-display" class="main-text">S. aureus</div>
                <div id="secondary-display" class="sub-text">¿Es catalasa positivo?</div>
            </div>
            
            <div class="options-grid" id="options-container">
                <!-- Botones JS -->
            </div>
        </div>

        <div id="feedback-area" class="feedback-area">
            <strong id="feedback-title"></strong>
            <p id="feedback-detail" style="margin: 5px 0 0 0; font-size: 0.95rem;"></p>
            <button id="ai-btn" class="ai-btn" onclick="askAI()">✨ Explicar con IA</button>
        </div>
        
        <button id="next-btn" class="action-btn" style="display: none;" onclick="nextQuestion()">Siguiente →</button>
    </div>

    <!-- PANTALLA FINAL -->
    <div class="container hide" id="end-screen">
        <h1 style="margin-bottom: 10px;">Resultados</h1>
        <div style="font-size: 3rem; font-weight: bold; color: var(--accent-color);" id="final-score">0%</div>
        <p id="final-message" style="font-size: 1.1rem; font-weight: bold;"></p>

        <div id="mistakes-container" class="mistakes-container hide">
            <h3 style="margin: 0; color: #c0392b; font-size: 1rem;">Temas a repasar:</h3>
            <ul id="mistakes-list" class="mistakes-list"></ul>
        </div>

        <button class="action-btn" onclick="showStartScreen()">Volver al Inicio</button>
    </div>

    <script>
        /* --- BASE DE DATOS EXTENDIDA (3 CASOS POR MICROBIO) --- */
        const microbios = [
            { 
                nombre: "Staphylococcus aureus", 
                gram: "Gram Positivo", catalasa: "Positivo", coagulasa: "Positivo",
                casos: [
                    "Paciente con forúnculo cutáneo y absceso doloroso. La muestra purulenta muestra cocos en racimos.",
                    "Usuario de drogas intravenosas con fiebre alta y soplo cardíaco nuevo (Endocarditis tricuspídea). Hemocultivos positivos.",
                    "Neonato con 'piel escaldada', ampollas generalizadas y signo de Nikolsky positivo."
                ]
            },
            { 
                nombre: "Staphylococcus epidermidis", 
                gram: "Gram Positivo", coagulasa: "Negativo",
                casos: [
                    "Paciente con infección de catéter venoso central. Hemocultivo positivo para cocos en racimos coagulasa negativo.",
                    "Paciente con prótesis valvular cardíaca que presenta fiebre baja persistente meses después de la cirugía.",
                    "Infección de shunt ventriculoperitoneal en niño con hidrocefalia."
                ]
            },
            { 
                nombre: "Staphylococcus saprophyticus", 
                gram: "Gram Positivo", coagulasa: "Negativo",
                casos: [
                    "Mujer joven sexualmente activa con disuria y polaquiuria. Urocultivo: Cocos G+ resistentes a Novobiocina.",
                    "Síndrome miccional en mujer de 22 años (" + "cistitis de la luna de miel" + "). Sedimento urinario con cocos G+.",
                    "Infección urinaria baja en mujer sana. El agente es coagulasa negativo y resistente a Novobiocina."
                ]
            },
            { 
                nombre: "Streptococcus pyogenes", 
                gram: "Gram Positivo", hemolisis: "Beta hemolítico", prueba: "Sensible a Bacitracina",
                casos: [
                    "Niño de 7 años con fiebre, odinofagia intensa y exudado faríngeo purulento. Cocos en cadenas.",
                    "Paciente con impétigo costroso color miel alrededor de la boca. Cultivo beta-hemolítico sensible a bacitracina.",
                    "Paciente con erisipela en pierna (placa roja brillante, dolorosa y bien delimitada) y fiebre alta."
                ]
            },
            { 
                nombre: "Streptococcus pneumoniae", 
                gram: "Gram Positivo", forma: "Diplococo lanceolado", capsula: "Positivo (Quellung +)",
                casos: [
                    "Adulto mayor con neumonía lobar, fiebre brusca y esputo herrumbroso. Gram: Diplococos lanceolados.",
                    "Niño con otitis media aguda purulenta. El agente es alfa-hemolítico y sensible a optoquina.",
                    "Paciente con meningitis y rigidez de nuca. LCR turbio con diplococos Gram positivos."
                ]
            },
            { 
                nombre: "Neisseria meningitidis", 
                gram: "Gram Negativo", forma: "Diplococo (grano café)", metabolismo: "Fermenta Maltosa y Glucosa",
                casos: [
                    "Adolescente con petequias en tronco, fiebre muy alta y rigidez de nuca. LCR con diplococos Gram negativos.",
                    "Brote de meningitis en un cuartel militar. El agente fermenta glucosa y maltosa.",
                    "Sepsis fulminante con hemorragia suprarrenal (Síndrome de Waterhouse-Friderichsen)."
                ]
            },
            { 
                nombre: "Neisseria gonorrhoeae", 
                gram: "Gram Negativo", forma: "Diplococo intracelular",
                casos: [
                    "Varón con secreción uretral purulenta abundante y disuria. Gram: diplococos G- dentro de polimorfonucleares.",
                    "Mujer con enfermedad pélvica inflamatoria (EPI) y dolor a la movilización del cuello uterino.",
                    "Recién nacido con conjuntivitis purulenta severa (oftalmia neonatorum) al 2do día de vida."
                ]
            },
            { 
                nombre: "Escherichia coli", 
                gram: "Gram Negativo", fermentacion: "Lactosa Positivo", prueba: "Indol Positivo",
                casos: [
                    "Mujer con cistitis no complicada. Urocultivo: Bacilo G- fermentador de lactosa e Indol positivo.",
                    "Recién nacido con meningitis y sepsis. El agente posee antígeno K1.",
                    "Paciente con diarrea del viajero tras volver del caribe. Diarrea acuosa sin sangre."
                ]
            },
            { 
                nombre: "Pseudomonas aeruginosa", 
                gram: "Gram Negativo", oxidasa: "Positivo", olor: "Frutas/Uvas",
                casos: [
                    "Paciente gran quemado con infección de herida que presenta pus verdoso y olor dulzón.",
                    "Otitis externa maligna en paciente diabético anciano. Dolor severo y otorrea.",
                    "Neumonía asociada a ventilador en paciente con fibrosis quística. Esputo mucoide."
                ]
            },
            { 
                nombre: "Treponema pallidum", 
                tincion: "Campo Oscuro", lesion: "Chancro duro",
                casos: [
                    "Paciente con úlcera genital indolora (chancro duro) de base limpia. VDRL positivo.",
                    "Paciente con exantema maculopapular en palmas y plantas (Sífilis secundaria).",
                    "Recién nacido con 'dientes de Hutchinson', nariz en silla de montar y tibia en sable."
                ]
            },
            { 
                nombre: "Mycobacterium tuberculosis", 
                tincion: "Ziehl-Neelsen (BAAR)", cultivo: "Lowenstein-Jensen",
                casos: [
                    "Paciente con tos crónica (>3 sem), hemoptisis, pérdida de peso y fiebre vespertina.",
                    "Radiografía de tórax con cavitación apical en paciente presidiario con tos productiva.",
                    "Meningitis basal de evolución lenta en paciente inmunodeprimido. LCR con hipoglucorraquia severa."
                ]
            },
            { 
                nombre: "Clostridium tetani", 
                gram: "Gram Positivo", forma: "Bacilo en palillo de tambor",
                casos: [
                    "Jardinero con herida punzante sucia. Días después presenta trismo (mandíbula trabada).",
                    "Paciente con risa sardónica y opistótonos (arqueamiento de espalda) tras herida con clavo oxidado.",
                    "Espasmos musculares generalizados ante estímulos mínimos en paciente no vacunado."
                ]
            },
            { 
                nombre: "Vibrio cholerae", 
                gram: "Gram Negativo", forma: "Bacilo curvo (coma)",
                casos: [
                    "Paciente con diarrea acuosa profusa ('agua de arroz') y deshidratación severa rápida.",
                    "Brote epidémico de diarrea tras consumo de mariscos crudos o agua contaminada.",
                    "Heces líquidas sin leucocitos ni sangre, pero con gran pérdida de electrolitos."
                ]
            },
            { 
                nombre: "Haemophilus influenzae", 
                gram: "Gram Negativo", cultivo: "Agar Chocolate (X y V)",
                casos: [
                    "Niño no vacunado (3 años) que llega babeando, con estridor y posición de trípode (Epiglotitis).",
                    "Otitis media o sinusitis en niño pequeño. Cultivo requiere factores X (Hemina) y V (NAD).",
                    "Meningitis en lactante no vacunado. Cocobacilo Gram negativo pleomórfico."
                ]
            },
            { 
                nombre: "Brucella spp.", 
                gram: "Gram Negativo", cultivo: "Hemocultivo (lento)",
                casos: [
                    "Veterinario o trabajador de frigorífico con 'fiebre ondulante', sudoración nocturna y dolor articular.",
                    "Paciente que consumió queso de cabra no pasteurizado y presenta fiebre y hepatoesplenomegalia.",
                    "Cuadro febril de larga data con sacroileítis (dolor lumbar bajo) en trabajador rural."
                ]
            },
            { 
                nombre: "Klebsiella pneumoniae", 
                gram: "Gram Negativo", fermentacion: "Lactosa Positivo", motilidad: "Inmóvil",
                casos: [
                    "Paciente alcohólico con neumonía severa. Esputo característico en 'jalea de grosella'.",
                    "Neumonía lobar con abombamiento de la cisura en la radiografía. Bacilo encapsulado.",
                    "Infección urinaria en paciente hospitalizado con sonda. Colonia mucosa en agar."
                ]
            },
            { 
                nombre: "Proteus mirabilis", 
                gram: "Gram Negativo", prueba: "Ureasa Positivo", caracteristica: "Swarming",
                casos: [
                    "Paciente con litiasis renal coraliforme (cálculos de estruvita) e infección urinaria recurrente.",
                    "Orina con pH muy alcalino y olor amoniacal fuerte.",
                    "Cultivo en placa muestra crecimiento en ondas concéntricas que cubre todo el agar (Swarming)."
                ]
            }
        ];

        /* --- VARIABLES GLOBALES --- */
        let currentQIndex = 0;
        let score = 0;
        let questionsQueue = [];
        let mistakes = []; 
        let maxQuestions = 10;

        /* --- ELEMENTOS DOM --- */
        const ui = {
            startScreen: document.getElementById('start-screen'),
            gameContainer: document.getElementById('game-container'),
            endScreen: document.getElementById('end-screen'),
            selectCount: document.getElementById('q-count-select'),
            badge: document.getElementById('question-badge'),
            primary: document.getElementById('primary-display'),
            secondary: document.getElementById('secondary-display'),
            options: document.getElementById('options-container'),
            feedbackArea: document.getElementById('feedback-area'),
            feedbackTitle: document.getElementById('feedback-title'),
            feedbackDetail: document.getElementById('feedback-detail'),
            nextBtn: document.getElementById('next-btn'),
            aiBtn: document.getElementById('ai-btn'),
            counter: document.getElementById('question-counter'),
            score: document.getElementById('score-display'),
            finalScore: document.getElementById('final-score'),
            finalMsg: document.getElementById('final-message'),
            mistakesContainer: document.getElementById('mistakes-container'),
            mistakesList: document.getElementById('mistakes-list')
        };

        /* --- FLUJO DEL JUEGO --- */

        function showStartScreen() {
            ui.gameContainer.classList.add('hide');
            ui.endScreen.classList.add('hide');
            ui.startScreen.classList.remove('hide');
        }

        function initGame() {
            const val = ui.selectCount.value;
            maxQuestions = parseInt(val);
            ui.startScreen.classList.add('hide');
            ui.gameContainer.classList.remove('hide');
            startGameLogic();
        }

        function startGameLogic() {
            score = 0;
            currentQIndex = 0;
            mistakes = [];
            ui.score.innerText = "Pts: 0";
            generateQuestionQueue();
            loadQuestion();
        }

        function generateQuestionQueue() {
            questionsQueue = [];
            let limit = (maxQuestions === 999) ? 50 : maxQuestions;

            for (let i = 0; i < limit; i++) {
                const randomMicrobe = microbios[Math.floor(Math.random() * microbios.length)];
                
                // Verificar si tiene casos clínicos definidos
                const hasCases = randomMicrobe.casos && randomMicrobe.casos.length > 0;
                
                // 50% probabilidad de Caso Clínico (si existe) vs Teórica
                const isClinical = Math.random() > 0.5 && hasCases;
                
                if (isClinical) {
                    // Seleccionar UNO de los 3 casos al azar
                    const randomCaseText = randomMicrobe.casos[Math.floor(Math.random() * randomMicrobe.casos.length)];
                    
                    questionsQueue.push({
                        type: 'clinical',
                        microbe: randomMicrobe,
                        text: randomCaseText,
                        correctAnswer: randomMicrobe.nombre
                    });
                } else {
                    // Pregunta teórica
                    const keys = Object.keys(randomMicrobe).filter(k => k !== 'nombre' && k !== 'casos');
                    const randomKey = keys[Math.floor(Math.random() * keys.length)];
                    questionsQueue.push({
                        type: 'theory',
                        microbe: randomMicrobe,
                        key: randomKey,
                        correctAnswer: randomMicrobe[randomKey]
                    });
                }
            }
            maxQuestions = questionsQueue.length;
        }

        function loadQuestion() {
            if (currentQIndex >= maxQuestions) {
                endGame();
                return;
            }

            const q = questionsQueue[currentQIndex];
            ui.counter.innerText = `${currentQIndex + 1}/${maxQuestions}`;
            ui.feedbackArea.classList.remove('feedback-visible');
            ui.feedbackArea.style.display = 'none';
            ui.nextBtn.style.display = "none";
            ui.aiBtn.style.display = "none";
            ui.options.innerHTML = "";

            if (q.type === 'clinical') {
                ui.badge.className = "badge-type type-clinical";
                ui.badge.innerText = "Caso Clínico";
                ui.primary.innerText = "Diagnóstico Presuntivo";
                ui.primary.style.fontSize = "1.1rem";
                ui.secondary.innerText = q.text;
                renderOptions(getMicrobeNamesDistractors(q.correctAnswer), q.correctAnswer);
            } else {
                ui.badge.className = "badge-type type-theory";
                ui.badge.innerText = "Teoría";
                ui.primary.innerText = q.microbe.nombre;
                ui.primary.style.fontSize = "1.3rem";
                ui.secondary.innerText = formatQuestionText(q.key);
                renderOptions(getPropertyDistractors(q.key, q.correctAnswer), q.correctAnswer);
            }
        }

        function renderOptions(optionsList, correct) {
            const shuffled = [...optionsList, correct].sort(() => Math.random() - 0.5);
            shuffled.forEach(opt => {
                const btn = document.createElement('button');
                btn.innerText = opt;
                btn.className = 'option-btn';
                btn.onclick = () => checkAnswer(btn, opt, correct);
                ui.options.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected, correct) {
            const btns = ui.options.querySelectorAll('button.option-btn');
            btns.forEach(b => b.disabled = true);
            const q = questionsQueue[currentQIndex];

            ui.feedbackArea.style.display = 'block';
            ui.feedbackArea.classList.add('feedback-visible');

            if (selected === correct) {
                btn.classList.add('correct');
                ui.feedbackTitle.innerText = "¡Correcto!";
                ui.feedbackTitle.style.color = "var(--correct-color)";
                ui.feedbackDetail.innerText = "";
                score++;
                ui.score.innerText = `Pts: ${score}`;
            } else {
                btn.classList.add('wrong');
                ui.feedbackTitle.innerText = "Incorrecto";
                ui.feedbackTitle.style.color = "var(--wrong-color)";
                ui.feedbackDetail.innerText = `Respuesta: ${correct}`;
                
                btns.forEach(b => {
                    if (b.innerText === correct) b.classList.add('correct');
                });
                
                mistakes.push(`${q.microbe.nombre} (${q.type === 'clinical' ? 'Caso' : q.key})`);
            }
            ui.nextBtn.style.display = "block";
            ui.aiBtn.style.display = "block";
        }

        /* --- LÓGICA DE IA --- */
        function askAI() {
            const q = questionsQueue[currentQIndex];
            let promptText = "";
            if (q.type === 'clinical') {
                promptText = `Soy estudiante de medicina. Tengo este caso clínico de microbiología: "${q.text}". La respuesta correcta es "${q.correctAnswer}". Por favor explícame la fisiopatología, por qué es ese microorganismo y descarta las otras posibilidades comunes. Sé breve y didáctico.`;
            } else {
                promptText = `Soy estudiante de medicina. Estoy estudiando microbiología sobre "${q.microbe.nombre}". La pregunta es sobre "${q.key}" y la respuesta correcta es "${q.correctAnswer}". Explícame por qué tiene esa característica y su importancia clínica.`;
            }
            const encodedPrompt = encodeURIComponent(promptText);
            const url = `https://chatgpt.com/?q=${encodedPrompt}`;
            window.open(url, '_blank');
        }

        function nextQuestion() {
            currentQIndex++;
            loadQuestion();
        }

        /* --- GENERADORES DE OPCIONES --- */

        function formatQuestionText(key) {
            const map = { gram: "¿Reacción al Gram?", catalasa: "¿Catalasa?", coagulasa: "¿Coagulasa?", oxidasa: "¿Oxidasa?", hemolisis: "¿Hemólisis?", fermentacion: "¿Fermentación?", cultivo: "¿Medio de cultivo?", tincion: "¿Tinción?", motilidad: "¿Movilidad?", espora: "¿Espora?", capsula: "¿Cápsula?", prueba: "¿Prueba Bioquímica?", metabolismo: "¿Metabolismo?" };
            return map[key] || `¿${key.charAt(0).toUpperCase() + key.slice(1)}?`;
        }

        function getMicrobeNamesDistractors(correct) {
            const allNames = microbios.map(m => m.nombre);
            const uniqueOptions = [...new Set(allNames)].filter(n => n !== correct);
            return uniqueOptions.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        function getPropertyDistractors(key, correct) {
            let pool = [];
            if(key === 'gram') pool = ["Gram Positivo", "Gram Negativo", "Gram Variable", "No visualizable"];
            else if(['catalasa','coagulasa','oxidasa','motilidad','capsula'].includes(key)) pool = ["Positivo", "Negativo", "Variable"];
            else if(key === 'hemolisis') pool = ["Alfa hemolítico", "Beta hemolítico", "Gamma hemolítico"];
            else {
                pool = microbios.map(m => m[key]).filter(v => v);
                pool.push("No aplica", "Variable", "Indeterminado");
            }
            // Eliminar duplicados y filtrar correcta
            const uniqueOptions = [...new Set(pool)].filter(opt => opt !== correct);
            return uniqueOptions.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        function endGame() {
            ui.gameContainer.classList.add('hide');
            ui.endScreen.classList.remove('hide');
            
            const percentage = Math.round((score / maxQuestions) * 100);
            ui.finalScore.innerText = `${percentage}%`;
            
            if(percentage >= 60) ui.finalMsg.innerText = "¡Aprobado!"; 
            else ui.finalMsg.innerText = "Sigue practicando.";

            if (mistakes.length > 0) {
                ui.mistakesContainer.classList.remove('hide');
                ui.mistakesList.innerHTML = "";
                mistakes.forEach(m => {
                    const li = document.createElement('li');
                    li.innerText = m;
                    ui.mistakesList.appendChild(li);
                });
            } else {
                ui.mistakesContainer.classList.add('hide');
                ui.finalMsg.innerText = "¡Excelente! Sin errores.";
            }
        }
    </script>
</body>
</html>
