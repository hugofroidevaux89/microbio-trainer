<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microbiología UNR - App de Estudio</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --clinical-color: #e67e22; /* Naranja para casos */
            --fact-color: #27ae60;     /* Verde para datos duros */
            --bg-color: #f4f6f7;
            --text-color: #2c3e50;
            --correct-color: #27ae60;
            --wrong-color: #c0392b;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            max-width: 750px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        /* Header */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        h1 { font-size: 1.3rem; color: var(--primary-color); margin: 0; text-align: left; }
        
        .score-badge { 
            background: var(--primary-color); 
            color: white; 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 0.9rem; 
            font-weight: bold;
        }

        /* Configuración */
        .config-box {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        select {
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background-color: white;
            color: var(--text-color);
            width: 100%;
            cursor: pointer;
        }

        /* Etiquetas */
        .badge-column {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            color: white;
        }

        .mode-theory { background-color: var(--accent-color); }
        .mode-case { background-color: var(--clinical-color); }
        .mode-fact { background-color: var(--fact-color); }

        .question-content { margin: 10px 0 20px 0; }

        .main-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .sub-text {
            font-size: 1.1rem;
            color: #555;
            min-height: 1.2em;
            font-weight: 500;
            line-height: 1.4;
        }

        /* Opciones */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }

        button.option-btn {
            padding: 12px;
            font-size: 0.95rem;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            color: #34495e;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 60px;
        }

        button.option-btn:hover:not([disabled]) {
            background-color: #e8f6fd;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        button.correct { background-color: var(--correct-color) !important; color: white !important; border-color: var(--correct-color) !important; }
        button.wrong { background-color: var(--wrong-color) !important; color: white !important; border-color: var(--wrong-color) !important; opacity: 0.8; }

        /* Feedback */
        .feedback-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #eef2f3;
            border-left: 5px solid var(--accent-color);
            text-align: left;
            display: none;
        }
        
        .feedback-visible { display: block; animation: fadeIn 0.3s; }

        .feedback-title { font-weight: bold; display: block; margin-bottom: 5px; color: var(--primary-color); }
        .feedback-content { font-size: 0.95rem; line-height: 1.4; color: #444; }

        /* Botones Acción */
        .action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1rem;
            border-radius: 8px;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .action-btn:hover { background-color: #34495e; }

        .ai-btn {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            width: 100%;
            font-size: 0.9rem;
        }

        .hide { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .mistakes-list {
            text-align: left;
            padding-left: 20px;
            color: var(--wrong-color);
            margin-top: 10px;
        }
        .mistakes-list li { margin-bottom: 5px; }

    </style>
</head>
<body>

    <!-- PANTALLA DE INICIO -->
    <div class="container" id="start-screen">
        <h1>Microbiología UNR</h1>
        
        <div class="config-box">
            <label for="q-count-select" style="font-weight: bold; text-align: left;">Configuración:</label>
            <select id="q-count-select">
                <option value="10">10 Preguntas (Rápido)</option>
                <option value="20" selected>20 Preguntas (Estándar)</option>
                <option value="50">50 Preguntas (Intensivo)</option>
                <option value="999">Todas las posibles</option>
            </select>
        </div>

        <button class="action-btn" onclick="initGame()">COMENZAR</button>
    </div>

    <!-- PANTALLA DE JUEGO -->
    <div class="container hide" id="game-container">
        <div class="header-bar">
            <h1>Microbiología</h1>
            <div class="score-badge">
                <span id="question-counter">1/10</span> | <span id="score-display">Pts: 0</span>
            </div>
        </div>

        <!-- Área de la pregunta -->
        <div id="quiz-area">
            <span id="column-badge" class="badge-column">CATEGORÍA</span>
            
            <div class="question-content">
                <div id="main-display" class="main-text">Título</div>
                <div id="sub-display" class="sub-text">Pregunta...</div>
            </div>
            
            <div class="options-grid" id="options-container">
                <!-- Botones JS -->
            </div>
        </div>

        <!-- Feedback Didáctico -->
        <div id="feedback-area" class="feedback-area">
            <span id="feedback-status" class="feedback-title"></span>
            <div id="feedback-text" class="feedback-content"></div>
            <button id="ai-btn" class="ai-btn" onclick="askAI()">✨ Explicar con IA</button>
        </div>
        
        <button id="next-btn" class="action-btn" style="display: none;" onclick="nextQuestion()">Siguiente →</button>
    </div>

    <!-- PANTALLA FINAL -->
    <div class="container hide" id="end-screen">
        <h1 style="margin-bottom: 10px;">Resultados</h1>
        <div style="font-size: 3rem; font-weight: bold; color: var(--accent-color);" id="final-score">0%</div>
        <p id="final-message" style="font-size: 1.1rem; font-weight: bold;"></p>

        <div id="mistakes-container" class="hide" style="margin-top: 20px; text-align: left; background: #fff5f5; padding: 15px; border-radius: 8px;">
            <h3 style="margin: 0 0 10px 0; color: #c0392b; font-size: 1rem;">Repasar estos temas:</h3>
            <ul id="mistakes-list" class="mistakes-list"></ul>
        </div>

        <button class="action-btn" onclick="showStartScreen()">Volver al Inicio</button>
    </div>

    <!-- CARGA DE DATOS EXTERNA -->
    <script src="data.js"></script>

    <script>
        /* --- LOGICA DEL JUEGO --- */
        let currentQIndex = 0;
        let score = 0;
        let questionsQueue = [];
        let mistakes = []; 
        let maxQuestions = 20;
        let microbios = []; // Se llenará desde data.js

        const ui = {
            startScreen: document.getElementById('start-screen'),
            gameContainer: document.getElementById('game-container'),
            endScreen: document.getElementById('end-screen'),
            selectCount: document.getElementById('q-count-select'),
            badge: document.getElementById('column-badge'),
            mainDisplay: document.getElementById('main-display'),
            subDisplay: document.getElementById('sub-display'),
            options: document.getElementById('options-container'),
            feedbackArea: document.getElementById('feedback-area'),
            feedbackStatus: document.getElementById('feedback-status'),
            feedbackText: document.getElementById('feedback-text'),
            nextBtn: document.getElementById('next-btn'),
            aiBtn: document.getElementById('ai-btn'),
            counter: document.getElementById('question-counter'),
            score: document.getElementById('score-display'),
            finalScore: document.getElementById('final-score'),
            finalMsg: document.getElementById('final-message'),
            mistakesContainer: document.getElementById('mistakes-container'),
            mistakesList: document.getElementById('mistakes-list')
        };

        function initGame() {
            // Cargar datos desde la variable global definida en data.js
            if (typeof microbiosData !== 'undefined') {
                microbios = microbiosData;
            } else {
                alert("Error: No se encuentra el archivo data.js. Asegúrate de que esté en la misma carpeta.");
                return;
            }

            const val = ui.selectCount.value;
            maxQuestions = parseInt(val);
            ui.startScreen.classList.add('hide');
            ui.gameContainer.classList.remove('hide');
            startGameLogic();
        }

        function startGameLogic() {
            score = 0;
            currentQIndex = 0;
            mistakes = [];
            ui.score.innerText = "Pts: 0";
            generateQuestionQueue();
            loadQuestion();
        }

        function generateQuestionQueue() {
            questionsQueue = [];
            let limit = (maxQuestions === 999) ? microbios.length : maxQuestions;
            // Prevenir loop infinito si pide más preguntas de las posibles
            if (limit > microbios.length * 3) limit = microbios.length * 3;

            const shuffledMicrobios = [...microbios].sort(() => Math.random() - 0.5);

            for (let i = 0; i < limit; i++) {
                const randomMicrobe = shuffledMicrobios[i % shuffledMicrobios.length];
                
                // Decidir si es Caso Clínico (40%) o Teórico (60%)
                const hasCases = randomMicrobe.casos && randomMicrobe.casos.length > 0;
                const isCase = Math.random() < 0.4 && hasCases;

                if (isCase) {
                    const randomCase = randomMicrobe.casos[Math.floor(Math.random() * randomMicrobe.casos.length)];
                    questionsQueue.push({
                        type: 'case',
                        microbe: randomMicrobe,
                        questionText: randomCase,
                        correctAnswer: randomMicrobe.nombre,
                        category: 'CASO CLÍNICO'
                    });
                } else {
                    // Teórico
                    const validKeys = Object.keys(randomMicrobe).filter(k => k !== 'nombre' && k !== 'casos');
                    if (validKeys.length > 0) {
                        const randomKey = validKeys[Math.floor(Math.random() * validKeys.length)];
                        questionsQueue.push({
                            type: 'theory',
                            microbe: randomMicrobe,
                            questionText: getQuestionText(randomKey),
                            correctAnswer: randomMicrobe[randomKey],
                            key: randomKey,
                            category: formatKeyName(randomKey)
                        });
                    }
                }
            }
            maxQuestions = questionsQueue.length;
        }

        function loadQuestion() {
            if (currentQIndex >= maxQuestions) {
                endGame();
                return;
            }

            const q = questionsQueue[currentQIndex];
            
            ui.counter.innerText = `${currentQIndex + 1}/${maxQuestions}`;
            ui.feedbackArea.classList.remove('feedback-visible');
            ui.feedbackArea.style.display = 'none';
            ui.nextBtn.style.display = "none";
            ui.aiBtn.style.display = "none"; 
            ui.options.innerHTML = "";

            // Config Visual
            ui.badge.innerText = q.category;
            
            if (q.type === 'case') {
                ui.badge.className = 'badge-column mode-case';
                ui.mainDisplay.innerText = "Diagnóstico Presuntivo";
                ui.subDisplay.innerText = q.questionText;
                renderOptions(getMicrobeNamesDistractors(q.correctAnswer), q.correctAnswer);
            } else {
                // Modo Teórico
                // Distinguir dato duro vs narrativo para el color del badge
                const isFact = ['familia','genoma','gram','catalasa','coagulasa','oxidasa','tipo','forma'].includes(q.key);
                ui.badge.className = isFact ? 'badge-column mode-fact' : 'badge-column mode-theory';
                
                ui.mainDisplay.innerText = q.microbe.nombre;
                ui.subDisplay.innerText = q.questionText;
                renderOptions(getPropertyDistractors(q.key, q.correctAnswer), q.correctAnswer);
            }
        }

        function renderOptions(optionsList, correct) {
            const shuffled = [...optionsList, correct].sort(() => Math.random() - 0.5);
            shuffled.forEach(opt => {
                const btn = document.createElement('button');
                btn.innerText = opt;
                btn.className = 'option-btn';
                btn.onclick = () => checkAnswer(btn, opt, correct);
                ui.options.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected, correct) {
            const btns = ui.options.querySelectorAll('button.option-btn');
            btns.forEach(b => b.disabled = true);
            const q = questionsQueue[currentQIndex];

            ui.feedbackArea.style.display = 'block';
            ui.feedbackArea.classList.add('feedback-visible');

            if (selected === correct) {
                btn.classList.add('correct');
                ui.feedbackStatus.innerText = "¡Correcto!";
                ui.feedbackStatus.style.color = "var(--correct-color)";
                score++;
                ui.score.innerText = `Pts: ${score}`;
            } else {
                btn.classList.add('wrong');
                ui.feedbackStatus.innerText = "Incorrecto";
                ui.feedbackStatus.style.color = "var(--wrong-color)";
                
                btns.forEach(b => {
                    if (b.innerText === correct) b.classList.add('correct');
                });
                
                mistakes.push(`${q.microbe.nombre} (${q.category})`);
            }

            // Texto de feedback
            if (q.type === 'case') {
                ui.feedbackText.innerHTML = `<strong>Diagnóstico:</strong> ${correct}<br>El cuadro clínico corresponde a este microorganismo.`;
            } else {
                ui.feedbackText.innerHTML = `<strong>Respuesta Correcta:</strong><br>${correct}`;
            }
            
            ui.nextBtn.style.display = "block";
            ui.aiBtn.style.display = "block";
        }

        /* --- GENERADORES --- */

        function formatKeyName(key) {
            return key.replace(/_/g, ' ').toUpperCase();
        }

        function getQuestionText(key) {
            const map = {
                gram: "¿Cuál es su tinción de Gram?",
                catalasa: "¿Prueba de Catalasa?",
                coagulasa: "¿Prueba de Coagulasa?",
                oxidasa: "¿Prueba de Oxidasa?",
                clinica: "¿Qué cuadro clínico describe?",
                diagnostico: "¿Cómo se realiza el diagnóstico?",
                transmision: "¿Vía de transmisión?",
                habitat: "¿Cuál es su hábitat o reservorio?",
                vector: "¿Cuál es el vector transmisor?",
                patogenia: "¿Mecanismo patogénico?",
                zona_endemica: "¿Zona endémica?",
                incubacion: "¿Período de incubación?",
                complicacion: "¿Complicación característica?",
                familia: "¿A qué familia pertenece?",
                genoma: "¿Tipo de genoma?"
            };
            return map[key] || `¿Característica: ${formatKeyName(key)}?`;
        }

        function getMicrobeNamesDistractors(correct) {
            const all = microbios.map(m => m.nombre).filter(n => n !== correct);
            return [...new Set(all)].sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        function getPropertyDistractors(key, correct) {
            let pool = [];
            // Datos duros fijos
            if(key === 'gram') pool = ["Gram Positivo", "Gram Negativo", "No visualizable (BAAR/Espiroqueta)"];
            else if(['catalasa','coagulasa','oxidasa'].includes(key)) pool = ["Positivo", "Negativo"];
            else if(key === 'genoma') pool = ["ADN envuelto", "ADN desnudo", "ARN envuelto", "ARN desnudo"];
            else {
                // Datos narrativos: sacar de otros microbios
                pool = microbios.map(m => m[key]).filter(v => v);
                if(pool.length < 3) pool.push("No aplica", "Variable");
            }
            // Filtrar y mezclar
            const uniqueOptions = [...new Set(pool)].filter(opt => opt !== correct);
            return uniqueOptions.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        function askAI() {
            const q = questionsQueue[currentQIndex];
            let promptText = "";
            if (q.type === 'case') {
                promptText = `Soy estudiante de medicina. Analiza este caso: "${q.questionText}". La respuesta es "${q.correctAnswer}". Explícame por qué.`;
            } else {
                promptText = `Soy estudiante de medicina. Microorganismo: "${q.microbe.nombre}". Explícame el concepto de "${q.key}": "${q.correctAnswer}".`;
            }
            const url = `https://chatgpt.com/?q=${encodeURIComponent(promptText)}`;
            window.open(url, '_blank');
        }

        function nextQuestion() {
            currentQIndex++;
            loadQuestion();
        }

        function showStartScreen() {
            ui.gameContainer.classList.add('hide');
            ui.endScreen.classList.add('hide');
            ui.startScreen.classList.remove('hide');
        }

        function endGame() {
            ui.gameContainer.classList.add('hide');
            ui.endScreen.classList.remove('hide');
            const pct = Math.round((score / maxQuestions) * 100);
            ui.finalScore.innerText = `${pct}%`;
            ui.finalMsg.innerText = pct >= 60 ? "¡Aprobado!" : "A repasar.";
            
            ui.mistakesContainer.classList.add('hide');
            if (mistakes.length > 0) {
                ui.mistakesContainer.classList.remove('hide');
                ui.mistakesList.innerHTML = "";
                mistakes.forEach(m => {
                    const li = document.createElement('li');
                    li.innerText = m;
                    ui.mistakesList.appendChild(li);
                });
            }
        }
    </script>
</body>
</html>
