<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microbiología UNR - Master Quiz</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #2980b9;
            --clinical-color: #d35400;
            --fact-color: #27ae60;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            --correct-color: #27ae60;
            --wrong-color: #c0392b;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            max-width: 750px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        /* Header */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        h1 { font-size: 1.3rem; color: var(--primary-color); margin: 0; text-align: left; }
        
        .score-badge { 
            background: var(--primary-color); 
            color: white; 
            padding: 5px 12px; 
            border-radius: 15px; 
            font-size: 0.9rem; 
            font-weight: bold;
        }

        /* Configuración Inicial */
        .config-box {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        select {
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background-color: white;
            color: var(--text-color);
            width: 100%;
            cursor: pointer;
        }

        /* Estilos de Pregunta */
        .badge-column {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            color: white;
        }

        /* Diferenciar colores según tipo de dato */
        .type-fact { background-color: var(--fact-color); } /* Gram, Catalasa */
        .type-desc { background-color: var(--clinical-color); } /* Clínica, Patogenia */

        .question-content { margin: 10px 0 20px 0; }

        .microbe-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
            font-style: italic;
        }

        .question-text {
            font-size: 1.1rem;
            color: #555;
            min-height: 1.2em;
            font-weight: 500;
        }

        /* Grilla de Opciones */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        @media (min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }

        button.option-btn {
            padding: 12px;
            font-size: 0.95rem;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            color: #34495e;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 60px;
            line-height: 1.3;
        }

        button.option-btn:hover:not([disabled]) {
            background-color: #e8f6fd;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        button.correct { background-color: var(--correct-color) !important; color: white !important; border-color: var(--correct-color) !important; }
        button.wrong { background-color: var(--wrong-color) !important; color: white !important; border-color: var(--wrong-color) !important; opacity: 0.8; }

        /* Feedback Area */
        .feedback-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #eef2f3;
            border-left: 5px solid var(--accent-color);
            text-align: left;
            display: none;
        }
        
        .feedback-visible { display: block; animation: fadeIn 0.3s; }

        .feedback-title { font-weight: bold; display: block; margin-bottom: 5px; color: var(--primary-color); }
        .feedback-content { font-size: 0.95rem; line-height: 1.4; color: #444; }

        /* Botones Acción */
        .action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1rem;
            border-radius: 8px;
            width: 100%;
            margin-top: 15px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .action-btn:hover { background-color: #34495e; }

        .ai-btn {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            width: 100%;
            font-size: 0.9rem;
        }

        .hide { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .mistakes-list {
            text-align: left;
            padding-left: 20px;
            color: var(--wrong-color);
            margin-top: 10px;
        }
        .mistakes-list li { margin-bottom: 5px; }

    </style>
</head>
<body>

    <!-- PANTALLA DE INICIO -->
    <div class="container" id="start-screen">
        <h1>Microbiología UNR</h1>
        <p style="color: #7f8c8d; margin-bottom: 20px;">
            Base de datos completa: Datos de los PDFs + Datos bioquímicos básicos.
        </p>
        
        <div class="config-box">
            <label for="q-count-select" style="font-weight: bold; text-align: left;">Configuración:</label>
            <select id="q-count-select">
                <option value="10">10 Preguntas (Rápido)</option>
                <option value="20" selected>20 Preguntas (Estándar)</option>
                <option value="50">50 Preguntas (Intensivo)</option>
                <option value="999">Todas las posibles</option>
            </select>
        </div>

        <button class="action-btn" onclick="initGame()">COMENZAR</button>
    </div>

    <!-- PANTALLA DE JUEGO -->
    <div class="container hide" id="game-container">
        <div class="header-bar">
            <h1>Microbiología</h1>
            <div class="score-badge">
                <span id="question-counter">1/10</span> | <span id="score-display">Pts: 0</span>
            </div>
        </div>

        <!-- Área de la pregunta -->
        <div id="quiz-area">
            <span id="column-badge" class="badge-column">CATEGORÍA</span>
            
            <div class="question-content">
                <div id="microbe-display" class="microbe-title">Nombre Microbio</div>
                <div id="question-text" class="question-text">¿Pregunta?</div>
            </div>
            
            <div class="options-grid" id="options-container">
                <!-- Botones JS -->
            </div>
        </div>

        <!-- Feedback Didáctico -->
        <div id="feedback-area" class="feedback-area">
            <span id="feedback-status" class="feedback-title"></span>
            <div id="feedback-text" class="feedback-content"></div>
            <button id="ai-btn" class="ai-btn" onclick="askAI()">✨ Explicar con IA</button>
        </div>
        
        <button id="next-btn" class="action-btn" style="display: none;" onclick="nextQuestion()">Siguiente →</button>
    </div>

    <!-- PANTALLA FINAL -->
    <div class="container hide" id="end-screen">
        <h1 style="margin-bottom: 10px;">Resultados</h1>
        <div style="font-size: 3rem; font-weight: bold; color: var(--accent-color);" id="final-score">0%</div>
        <p id="final-message" style="font-size: 1.1rem; font-weight: bold;"></p>

        <div id="mistakes-container" class="hide" style="margin-top: 20px; text-align: left; background: #fff5f5; padding: 15px; border-radius: 8px;">
            <h3 style="margin: 0 0 10px 0; color: #c0392b; font-size: 1rem;">Repasar estos temas:</h3>
            <ul id="mistakes-list" class="mistakes-list"></ul>
        </div>

        <button class="action-btn" onclick="showStartScreen()">Volver al Inicio</button>
    </div>

    <script>
        /* 
           BASE DE DATOS UNIFICADA (ULTIMATE)
           Combina datos cortos (Gram, Forma) con datos largos (PDFs).
        */
        const microbios = [
            // --- VIRUS ---
            { 
                nombre: "Virus Junín (Fiebre Hemorrágica Arg)",
                familia: "Arenavirus",
                genoma: "ARN envuelto",
                vector: "Ratón maicero (Calomys musculinus)",
                clinica: "Fiebre hemorrágica argentina. Inicio: decaimiento, cefalea. Hemorragias severas: hematemesis, melena. Ausencia de tos productiva.",
                diagnostico: "Células redondas en orina (cilindros hialinos). PCR. ELISA.",
                zona_endemica: "Pampa húmeda (noroeste de Bs As, sur de Santa Fe, Córdoba, La Pampa)."
            },
            {
                nombre: "Hantavirus (Andes)",
                familia: "Bunyavirus",
                vector: "Ratón colilargo (Oligoryzomys longicaudatus)",
                clinica: "Síndrome Pulmonar (SHP): fiebre, mialgias, cefalea. Evoluciona a distrés respiratorio rápido. Edema pulmonar no cardiogénico.",
                patogenia: "Los LFt actúan sobre el endotelio pulmonar incrementando la permeabilidad vascular (edema).",
                diagnostico: "Sangre: trombocitopenia, hemoconcentración, predominio de PMN. Búsqueda de IgM (ELISA)."
            },
            {
                nombre: "Dengue",
                familia: "Flavivirus",
                vector: "Aedes aegypti",
                clinica: "Sde febril inespecífico, dolor retroocular intenso, exantema. Signos de alarma: dolor abdominal, vómitos, sangrado.",
                patogenia: "El virus infecta monocitos. La respuesta inmune en reinfección por otro serotipo causa shock (fuga plasmática).",
                diagnostico: "Antígeno NS1 (primeros días). PCR. IgM (tardía)."
            },
            {
                nombre: "Sarampión",
                familia: "Paramyxoviridae",
                clinica: "Triple catarro, conjuntivitis. Patognomónico: Manchas de Koplik. Exantema máculo papular descendente.",
                diagnostico: "Clínico (Koplik). IgM.",
                complicacion: "Panencefalitis esclerosante subaguda (PEES). Otitis, neumonía."
            },
            {
                nombre: "Virus de la Rabia",
                familia: "Rhabdoviridae",
                genoma: "ARN envuelto (forma de bala)",
                transmision: "Mordedura (saliva infectada).",
                patogenia: "Neurotrópico: viaja por axones motores al SNC. Cuerpos de Negri.",
                clinica: "Hidrofobia, espasmos laríngeos, sialorrea, encefalitis mortal.",
                diagnostico: "IFD en biopsia de nuca/cornea. PCR."
            },
            {
                nombre: "Hepatitis A (HAV)",
                genoma: "ARN desnudo",
                transmision: "Fecal-oral.",
                clinica: "Generalmente aguda y autolimitada. Ictericia, coluria. 95% asintomático en niños.",
                diagnostico: "IgM anti-HAV. Hepatograma alterado."
            },
            {
                nombre: "Hepatitis B (HBV)",
                genoma: "ADN envuelto",
                transmision: "Sexual, parenteral, vertical.",
                diagnostico: "HBsAg (Ag superficie) > 6 meses = Crónico. Anti-HBs = Inmunidad.",
                clinica: "Puede cronificar a cirrosis o hepatocarcinoma. Manifestaciones extrahepáticas."
            },
            {
                nombre: "Hepatitis C (HCV)",
                genoma: "ARN envuelto",
                transmision: "Parenteral (principal), sexual.",
                clinica: "80% Cronifica. Gran tendencia a cirrosis y cáncer.",
                diagnostico: "Anti-HCV y Carga Viral (PCR)."
            },
            {
                nombre: "HIV",
                familia: "Retroviridae",
                patogenia: "Destrucción de linfocitos T CD4. GP120 se une a CD4.",
                clinica: "Agudo: Sde mononucleósico. SIDA: Infecciones oportunistas (Pneumocystis, Toxoplasma, Candida, Kaposi).",
                diagnostico: "ELISA 4ta gen (Ag p24 + Ac). Confirmación con Carga Viral."
            },
            {
                nombre: "Rotavirus",
                clinica: "Diarrea acuosa en niños < 2 años. Vómitos, fiebre, deshidratación.",
                patogenia: "Destrucción de enterocitos, atrofia de vellosidades.",
                diagnostico: "Detección de Ag en heces (ELISA/Látex)."
            },

            // --- BACTERIAS ---
            { 
                nombre: "Staphylococcus aureus", 
                gram: "Gram Positivo", 
                forma: "Cocos en racimos", 
                catalasa: "Positivo", 
                coagulasa: "Positivo",
                clinica: "Piel (forúnculos, celulitis), Neumonía, Osteomielitis, Endocarditis, Shock Tóxico, Sde Piel Escaldada.",
                patogenia: "Enzimas (coagulasa, hialuronidasa) y Toxinas (TSST-1, Exfoliativas).",
                diagnostico: "Cultivo (agar sangre/manitol salado)."
            },
            { 
                nombre: "Staphylococcus epidermidis", 
                gram: "Gram Positivo", 
                coagulasa: "Negativo",
                clinica: "Infección de catéteres, prótesis valvulares, shunts. Infecciones nosocomiales.",
                patogenia: "Producción de Biofilm (Slime) que adhiere a plásticos.",
                diagnostico: "Hemocultivos seriados."
            },
            { 
                nombre: "Streptococcus pyogenes (Grupo A)", 
                gram: "Gram Positivo", 
                forma: "Cocos en cadenas", 
                hemolisis: "Beta hemolítico",
                catalasa: "Negativo",
                clinica: "Faringitis, Escarlatina, Erisipela, Impétigo. Pos-estrep: Fiebre Reumática, Glomerulonefritis.",
                diagnostico: "Cultivo, Test rápido Ag, ASTO (para secuelas)."
            },
            { 
                nombre: "Streptococcus pneumoniae (Neumococo)", 
                gram: "Gram Positivo", 
                forma: "Diplococo lanceolado", 
                capsula: "Sí (Factor de virulencia)",
                hemolisis: "Alfa hemolítico",
                clinica: "Neumonía típica (lobar), Meningitis, Otitis media, Sinusitis.",
                diagnostico: "Gram y Cultivo de esputo/LCR/sangre. Ag urinario."
            },
            { 
                nombre: "Neisseria meningitidis", 
                gram: "Gram Negativo", 
                forma: "Diplococo (grano de café)", 
                oxidasa: "Positivo",
                clinica: "Meningitis purulenta (rigidez nuca, fiebre). Meningococemia (petequias, shock).",
                diagnostico: "LCR (Gram, Cultivo, PCR).",
                complicacion: "Sde Waterhouse-Friderichsen."
            },
            {
                nombre: "Neisseria gonorrhoeae",
                gram: "Gram Negativo",
                forma: "Diplococo intracelular",
                transmision: "Sexual (ITS)",
                clinica: "Uretritis purulenta (hombre), Cervicitis (mujer), Oftalmia neonatal, Artritis séptica.",
                diagnostico: "Gram de secreción uretral. Cultivo Thayer-Martin."
            },
            {
                nombre: "Escherichia coli",
                gram: "Gram Negativo",
                forma: "Bacilo",
                fermentacion: "Lactosa Positivo",
                clinica: "ITU (Cistitis/Pielonefritis). EHEC: Diarrea sanguinolenta y SUH (Sde Urémico Hemolítico).",
                patogenia: "Fimbrias (ITU). Toxina Shiga (SUH).",
                diagnostico: "Urocultivo. Coprocultivo."
            },
            {
                nombre: "Salmonella spp.",
                gram: "Gram Negativo",
                fermentacion: "Lactosa Negativo",
                clinica: "Gastroenteritis (diarrea, fiebre, dolor). Fiebre Tifoidea (S. typhi: fiebre alta, bradicardia, hepatoespleno).",
                transmision: "Aves, huevos, alimentos contaminados.",
                diagnostico: "Coprocultivo. Hemocultivo (Tifoidea)."
            },
            {
                nombre: "Shigella",
                gram: "Gram Negativo",
                motilidad: "Inmóvil",
                clinica: "Disentería (diarrea con sangre, moco y pus), pujo y tenesmo.",
                patogenia: "Invasión mucosa colónica. Toxina Shiga.",
                diagnostico: "Coprocultivo."
            },
            {
                nombre: "Pseudomonas aeruginosa",
                gram: "Gram Negativo",
                metabolismo: "No fermentador / Aerobio estricto",
                oxidasa: "Positivo",
                clinica: "Infecciones en quemados, Fibrosis Quística, Otitis externa maligna, Neumonía ARM.",
                caracteristicas: "Pigmentos verde/azul. Olor a frutas.",
                diagnostico: "Cultivo."
            },
            {
                nombre: "Brucella spp.",
                gram: "Gram Negativo",
                forma: "Cocobacilo",
                clinica: "Fiebre ondulante, sudoración nocturna, sacroileítis, orquitis.",
                transmision: "Lácteos no pasteurizados, contacto animal.",
                diagnostico: "Hemocultivo (lento). Huddleson/Wright."
            },
            {
                nombre: "Bordetella pertussis",
                gram: "Gram Negativo",
                clinica: "Tos convulsa (coqueluche): accesos, gallo inspiratorio, vómitos post-tusivos.",
                diagnostico: "PCR nasofaríngea. Cultivo (Bordet-Gengou).",
                patogenia: "Toxina pertussis, citotoxina traqueal."
            },
            {
                nombre: "Haemophilus influenzae b",
                gram: "Gram Negativo",
                forma: "Cocobacilo",
                cultivo: "Agar Chocolate (Factores X y V)",
                clinica: "Meningitis (niños no vacunados), Epiglotitis, Neumonía.",
                diagnostico: "Cultivo. Ag capsular."
            },
            {
                nombre: "Treponema pallidum (Sífilis)",
                tipo: "Espiroqueta",
                visualizacion: "Campo oscuro (no se tiñe Gram)",
                clinica: "1°: Chancro duro. 2°: Roséola. 3°: Gomas, neurosífilis. Congénita.",
                diagnostico: "VDRL (screening), FTA-abs (confirmatoria)."
            },
            {
                nombre: "Vibrio cholerae",
                gram: "Gram Negativo",
                forma: "Bacilo curvo (coma)",
                clinica: "Diarrea acuosa 'agua de arroz', deshidratación grave rápida.",
                patogenia: "Toxina colérica (aumenta AMPc).",
                transmision: "Agua/mariscos contaminados."
            },
            {
                nombre: "Clostridium tetani",
                gram: "Gram Positivo",
                espora: "Esporulado (Palillo de tambor)",
                respiracion: "Anaerobio estricto",
                clinica: "Trismo, risa sardónica, opistótonos (parálisis rígida).",
                patogenia: "Tetanospasmina bloquea GABA."
            },
            {
                nombre: "Clostridium botulinum",
                gram: "Gram Positivo",
                respiracion: "Anaerobio estricto",
                clinica: "Parálisis flácida descendente, diplopía, disfagia. Botulismo del lactante (miel).",
                patogenia: "Toxina botulínica bloquea Acetilcolina."
            },
            {
                nombre: "Mycobacterium tuberculosis",
                tincion: "BAAR (Ziehl-Neelsen)",
                cultivo: "Lowenstein-Jensen",
                clinica: "Tos crónica, hemoptisis, pérdida de peso, sudoración nocturna. Cavernas apicales.",
                diagnostico: "Baciloscopía, Cultivo, PCR."
            },
            {
                nombre: "Leptospira interrogans",
                tipo: "Espiroqueta (con ganchos)",
                transmision: "Orina roedores/agua (inundaciones).",
                clinica: "Fiebre, mialgias (pantorrillas). Grave: Sde Weil (Ictericia + Falla Renal).",
                diagnostico: "Microaglutinación (MAT)."
            },
            {
                nombre: "Chlamydia trachomatis",
                tipo: "Intracelular obligado",
                clinica: "Uretritis, Cervicitis, EPI, Linfogranuloma venéreo, Tracoma, Neumonía neonatal.",
                diagnostico: "PCR, IFD. No cultiva en medios artificiales."
            },

            // --- HONGOS ---
            {
                nombre: "Histoplasma capsulatum",
                tipo: "Hongo dimórfico",
                habitat: "Guano de aves/murciélagos.",
                zona_endemica: "Pampa Húmeda.",
                clinica: "Pulmonar aguda. Diseminada en SIDA (pancitopenia, úlceras).",
                diagnostico: "Cultivo, Escarificación, Serología."
            },
            {
                nombre: "Paracoccidioides brasiliensis",
                tipo: "Hongo dimórfico",
                diagnostico: "Levadura multigemante ('Rueda de timón').",
                zona_endemica: "Noreste (Litoral/Subtropical).",
                clinica: "Estomatitis moriforme, adenopatías, neumopatía crónica."
            },
            {
                nombre: "Coccidioides posadasii",
                tipo: "Hongo dimórfico",
                diagnostico: "Esférula con endosporas.",
                zona_endemica: "Precordillera (Zona seca/Zonda).",
                clinica: "Neumonía, eritema nodoso, meningitis."
            },
            {
                nombre: "Candida albicans",
                tipo: "Levadura (Oportunista)",
                clinica: "Muguet, Vaginitis, Intertrigo, Fungemia (catéteres).",
                diagnostico: "Pseudohifas al directo. Cultivo."
            },
            {
                nombre: "Cryptococcus neoformans",
                tipo: "Levadura capsulada",
                habitat: "Guano de paloma.",
                clinica: "Meningitis en SIDA (cefalea, fiebre).",
                diagnostico: "Tinta China (LCR), Antígeno capsular."
            },
            {
                nombre: "Dermatofitos",
                tipo: "Hongos filamentosos",
                nutricion: "Queratinofílicos.",
                clinica: "Tiñas (capitis, corporis, pedis, unguium). Lesiones anulares.",
                diagnostico: "Examen directo con KOH, Cultivo."
            },

            // --- PARASITOS ---
            {
                nombre: "Trypanosoma cruzi",
                enfermedad: "Chagas",
                vector: "Vinchuca",
                clinica: "Agudo: Romaña. Crónico: Miocardiopatía, Megacolon.",
                diagnostico: "Agudo: Parasitemia (Strout). Crónico: Serología."
            },
            {
                nombre: "Toxoplasma gondii",
                huesped_definitivo: "Gato",
                transmision: "Carnes crudas, heces gato, transplacentaria.",
                clinica: "Congénita: Tetrada de Sabin (Hidrocefalia, calcificaciones, coriorretinitis). SIDA: Abscesos cerebrales.",
                diagnostico: "Serología (IgM/IgG). Avidez."
            },
            {
                nombre: "Giardia lamblia",
                tipo: "Protozoo flagelado",
                clinica: "Diarrea esteatorreica (grasa), malabsorción.",
                diagnostico: "Quistes en heces. Trofozoito 'cara de viejo'."
            },
            {
                nombre: "Trichinella spiralis",
                transmision: "Cerdo crudo (chacinados).",
                clinica: "Edema bipalpebral, mialgias, fiebre, eosinofilia.",
                diagnostico: "Serología, Enzimas musculares."
            },
            {
                nombre: "Enterobius vermicularis",
                tipo: "Nematode (Oxiuro)",
                clinica: "Prurito anal nocturno, bruxismo.",
                diagnostico: "Test de Graham (cinta adhesiva)."
            },
            {
                nombre: "Taenia saginata",
                transmision: "Carne vacuna cruda (Cisticerco).",
                clinica: "Eliminación de proglótides. Teniasis.",
                diagnostico: "Visualización de proglótides/huevos."
            }
        ];

        /* --- VARIABLES GLOBALES --- */
        let currentQIndex = 0;
        let score = 0;
        let questionsQueue = [];
        let mistakes = []; 
        let maxQuestions = 20;

        /* --- ELEMENTOS DOM --- */
        const ui = {
            startScreen: document.getElementById('start-screen'),
            gameContainer: document.getElementById('game-container'),
            endScreen: document.getElementById('end-screen'),
            selectCount: document.getElementById('q-count-select'),
            badge: document.getElementById('column-badge'),
            microbeName: document.getElementById('microbe-display'),
            qText: document.getElementById('question-text'),
            options: document.getElementById('options-container'),
            feedbackArea: document.getElementById('feedback-area'),
            feedbackStatus: document.getElementById('feedback-status'),
            feedbackText: document.getElementById('feedback-text'),
            nextBtn: document.getElementById('next-btn'),
            aiBtn: document.getElementById('ai-btn'),
            counter: document.getElementById('question-counter'),
            score: document.getElementById('score-display'),
            finalScore: document.getElementById('final-score'),
            finalMsg: document.getElementById('final-message'),
            mistakesContainer: document.getElementById('mistakes-container'),
            mistakesList: document.getElementById('mistakes-list')
        };

        /* --- FLUJO DEL JUEGO --- */

        function initGame() {
            const val = ui.selectCount.value;
            maxQuestions = parseInt(val);
            ui.startScreen.classList.add('hide');
            ui.gameContainer.classList.remove('hide');
            startGameLogic();
        }

        function startGameLogic() {
            score = 0;
            currentQIndex = 0;
            mistakes = [];
            ui.score.innerText = "Pts: 0";
            generateQuestionQueue();
            loadQuestion();
        }

        function generateQuestionQueue() {
            questionsQueue = [];
            let limit = (maxQuestions === 999) ? microbios.length : maxQuestions;
            if (limit > microbios.length) limit = microbios.length;

            const shuffledMicrobios = [...microbios].sort(() => Math.random() - 0.5);

            for (let i = 0; i < limit; i++) {
                const randomMicrobe = shuffledMicrobios[i];
                const validKeys = Object.keys(randomMicrobe).filter(k => k !== 'nombre');
                
                if (validKeys.length > 0) {
                    const randomKey = validKeys[Math.floor(Math.random() * validKeys.length)];
                    questionsQueue.push({
                        microbe: randomMicrobe,
                        key: randomKey,
                        correctAnswer: randomMicrobe[randomKey]
                    });
                }
            }
            maxQuestions = questionsQueue.length;
        }

        function loadQuestion() {
            if (currentQIndex >= maxQuestions) {
                endGame();
                return;
            }

            const q = questionsQueue[currentQIndex];
            
            // UI Reset
            ui.counter.innerText = `${currentQIndex + 1}/${maxQuestions}`;
            ui.feedbackArea.classList.remove('feedback-visible');
            ui.feedbackArea.style.display = 'none';
            ui.nextBtn.style.display = "none";
            ui.aiBtn.style.display = "none"; 
            ui.options.innerHTML = "";

            // Configuración visual según tipo de dato
            const isFact = ['gram','catalasa','coagulasa','oxidasa','tipo','forma'].includes(q.key);
            ui.badge.className = isFact ? 'badge-column type-fact' : 'badge-column type-desc';
            ui.badge.innerText = formatKeyName(q.key);
            
            ui.microbeName.innerText = q.microbe.nombre;
            ui.qText.innerText = getQuestionText(q.key);

            // Generar Opciones
            const distractors = getDistractors(q.key, q.correctAnswer);
            const allOptions = [...distractors, q.correctAnswer].sort(() => Math.random() - 0.5);

            allOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.innerText = opt;
                btn.className = 'option-btn';
                btn.onclick = () => checkAnswer(btn, opt, q.correctAnswer);
                ui.options.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected, correct) {
            const btns = ui.options.querySelectorAll('button.option-btn');
            btns.forEach(b => b.disabled = true);
            const q = questionsQueue[currentQIndex];

            ui.feedbackArea.style.display = 'block';
            ui.feedbackArea.classList.add('feedback-visible');

            if (selected === correct) {
                btn.classList.add('correct');
                ui.feedbackStatus.innerText = "¡Correcto!";
                ui.feedbackStatus.style.color = "var(--correct-color)";
                score++;
                ui.score.innerText = `Pts: ${score}`;
            } else {
                btn.classList.add('wrong');
                ui.feedbackStatus.innerText = "Incorrecto";
                ui.feedbackStatus.style.color = "var(--wrong-color)";
                
                btns.forEach(b => {
                    if (b.innerText === correct) b.classList.add('correct');
                });
                
                mistakes.push(`${q.microbe.nombre} (${formatKeyName(q.key)})`);
            }

            ui.feedbackText.innerHTML = `<strong>Dato Correcto (${formatKeyName(q.key)}):</strong><br>${correct}`;
            ui.nextBtn.style.display = "block";
            ui.aiBtn.style.display = "block";
        }

        function showStartScreen() {
            ui.gameContainer.classList.add('hide');
            ui.endScreen.classList.add('hide');
            ui.startScreen.classList.remove('hide');
        }

        /* --- LOGICA DE GENERACIÓN DE CONTENIDO --- */

        function formatKeyName(key) {
            return key.replace(/_/g, ' ').toUpperCase();
        }

        function getQuestionText(key) {
            const map = {
                gram: "¿Cuál es su tinción de Gram?",
                catalasa: "¿Prueba de Catalasa?",
                coagulasa: "¿Prueba de Coagulasa?",
                oxidasa: "¿Prueba de Oxidasa?",
                forma: "¿Morfología microscópica?",
                clinica: "¿Qué cuadro clínico describe?",
                diagnostico: "¿Cómo se realiza el diagnóstico?",
                transmision: "¿Vía de transmisión?",
                habitat: "¿Cuál es su hábitat o reservorio?",
                vector: "¿Cuál es el vector transmisor?",
                patogenia: "¿Mecanismo patogénico?",
                zona_endemica: "¿Zona endémica?",
                tipo: "¿Qué tipo de microorganismo es?",
                genoma: "¿Tipo de genoma viral?",
                fermentacion: "¿Características metabólicas?"
            };
            return map[key] || `¿Característica: ${formatKeyName(key)}?`;
        }

        function getDistractors(key, correctVal) {
            let pool = [];
            
            // Pools Fijos para datos "Duros"
            if(key === 'gram') pool = ["Gram Positivo", "Gram Negativo", "Gram Variable", "No se tiñe (BAAR/Espiroqueta)"];
            else if(['catalasa','coagulasa','oxidasa','capsula','motilidad'].includes(key)) pool = ["Positivo", "Negativo", "Variable"];
            else if(key === 'hemolisis') pool = ["Alfa hemolítico", "Beta hemolítico", "Gamma hemolítico"];
            else if(key === 'genoma') pool = ["ADN desnudo", "ADN envuelto", "ARN desnudo", "ARN envuelto"];
            else if(key === 'tipo') pool = ["Bacteria", "Virus", "Hongo", "Parásito", "Espiroqueta"];
            else {
                // Pools Dinámicos para datos "Narrativos" (PDFs)
                pool = microbios
                    .map(m => m[key])
                    .filter(v => v && v !== correctVal);
                
                // Si faltan distractores, rellenar con genéricos
                if(pool.length < 3) {
                    pool.push("Inespecífico", "Variable según huésped", "No aplica", "Desconocido");
                }
            }

            // Eliminar duplicados y la correcta
            const uniquePool = [...new Set(pool)].filter(v => v !== correctVal);
            
            // Mezclar y devolver 3
            return uniquePool.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        function askAI() {
            const q = questionsQueue[currentQIndex];
            const promptText = `Soy estudiante de medicina. Sobre el microorganismo "${q.microbe.nombre}". La pregunta es sobre "${q.key}" y la respuesta es "${q.correctAnswer}". Explícame brevemente este concepto y cómo diferenciarlo.`;
            const encodedPrompt = encodeURIComponent(promptText);
            const url = `https://chatgpt.com/?q=${encodedPrompt}`;
            window.open(url, '_blank');
        }

        function nextQuestion() {
            currentQIndex++;
            loadQuestion();
        }

        function endGame() {
            ui.gameContainer.classList.add('hide');
            ui.endScreen.classList.remove('hide');
            
            const percentage = Math.round((score / maxQuestions) * 100);
            ui.finalScore.innerText = `${percentage}%`;
            
            ui.finalMsg.innerText = percentage >= 60 ? "¡Aprobado!" : "A seguir estudiando.";

            if (mistakes.length > 0) {
                ui.mistakesContainer.classList.remove('hide');
                ui.mistakesList.innerHTML = "";
                mistakes.forEach(m => {
                    const li = document.createElement('li');
                    li.innerText = m;
                    ui.mistakesList.appendChild(li);
                });
            } else {
                ui.mistakesContainer.classList.add('hide');
                ui.finalMsg.innerText = "¡Excelente! Sin errores.";
            }
        }
    </script>
</body>
</html>
